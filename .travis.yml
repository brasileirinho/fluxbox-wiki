language: node_js
node_js:
  - "7"
script:
  - env
  - git log -n 3
  - git branch
  - cat .git/config
  - if [[ "$TRAVIS_EVENT_TYPE" == "pull_request" ]]; then node -e "e=process.env;d='';h=require('https').get({hostname:'api.github.com',path:'/repos/sillyslux/fluxbox-wiki/pulls/'+e.TRAVIS_PULL_REQUEST,headers:{'User-Agent':'travis'}},res=>{res.on('data',c=>d+=c);res.on('end',()=>{console.log('PR info:',JSON.parse(d))})});p=JSON.stringify({'commit_title':'Hello World'});f='';o={method:'PUT',hostname:'api.github.com',path:'/repos/sillyslux/fluxbox-wiki/pulls/'+e.TRAVIS_PULL_REQUEST+'/merge',auth:e.GITHUB_TOKEN,headers:{'User-Agent':'travis','Content-Type':'application/json','Content-Length':Buffer.byteLength(p)}};r=require('https').request(o,re=>{re.setEncoding('utf8');re.on('data',c=>f+=c);re.on('end',()=>console.log('PR merged',f))});r.on('error',e=>console.error('PR merge failed',e.message));r.write(p);r.end();"; else node -e "e=process.env;d='';h=require('https');h.get({hostname:'api.github.com',path:'/repos/'+e.TRAVIS_REPO_SLUG+'/git/commits/'+e.TRAVIS_COMMIT, headers:{'User-Agent':'travis'}},res=>{res.on('data',c=>d+=c);res.on('end',()=>{d=JSON.parse(d);p=JSON.stringify({request:{config:{env:{C_AUTHOR_NAME:d.author.name,C_AUTHOR_MAIL:d.author.email,C_COMMITTER_NAME:d.committer.name,C_COMMITTER_MAIL:d.committer.email,C_MESSAGE:d.message,C_URL:d.html_url}}}});require('https').request({hostname:'api.travis-ci.org',path:'/repo/sillyslux%2Ffluxbox-wiki-ssg/requests',method:'POST',headers:{'Content-Type':'application/json','Accept':'application/vnd.travis-ci.2+json','Travis-API-Version':'3','Authorization':'token '+e.TRAVIS_TOKEN,'Content-Length':Buffer.byteLength(p)}},res=>res.on('data',f=>console.log(f.toString()))).write(p)})})";fi;
git:
  depth: 1
branches:
  only:
  - master
